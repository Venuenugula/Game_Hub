<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe vs AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --primary-color: #bb86fc;
            --secondary-color: #03dac6;
            --error-color: #cf6679;
            --cell-bg: #1e1e1e;
            --cell-hover: #2c2c2c;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-align: center;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .game-container {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 10px;
            margin-bottom: 20px;
        }

        .cell {
            width: 100px;
            height: 100px;
            background-color: var(--cell-bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .cell:hover {
            background-color: var(--cell-hover);
            transform: scale(1.05);
        }

        .cell.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .cell.x {
            color: var(--primary-color);
        }

        .cell.o {
            color: var(--secondary-color);
        }

        #status {
            font-size: 1.5rem;
            margin-bottom: 20px;
            min-height: 1.5em;
        }

        button {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(187, 134, 252, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        #loading {
            display: none;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        @media (max-width: 400px) {
            .game-container {
                grid-template-columns: repeat(3, 80px);
                grid-template-rows: repeat(3, 80px);
            }

            .cell {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }
        }
    </style>
</head>

<body>

    <h1>Tic-Tac-Toe AI</h1>
    <div id="status">Your Turn!</div>
    <div id="loading">Agent is thinking...</div>

    <div class="game-container" id="board">
        <div class="cell" data-id="0"></div>
        <div class="cell" data-id="1"></div>
        <div class="cell" data-id="2"></div>
        <div class="cell" data-id="3"></div>
        <div class="cell" data-id="4"></div>
        <div class="cell" data-id="5"></div>
        <div class="cell" data-id="6"></div>
        <div class="cell" data-id="7"></div>
        <div class="cell" data-id="8"></div>
    </div>

    <button onclick="resetGame()">New Game</button>

    <script>
        let board = Array(9).fill(0);
        let gameOver = false;
        let isFetching = false;

        document.querySelectorAll(".cell").forEach(cell => {
            cell.addEventListener("click", async () => {
                const id = parseInt(cell.getAttribute("data-id"));
                if (isFetching || gameOver || board[id] !== 0) return;

                // Player move
                board[id] = -1;
                renderBoard();
                updateCellInteractivity();

                await makeMove(board);
            });
        });

        async function makeMove(boardState) {
            isFetching = true;
            showLoading(true);
            try {
                const boardToSend = boardState.map(Number);
                const res = await fetch("/api/tictactoe/move", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ board: boardToSend })
                });

                if (!res.ok) throw new Error("Server error");

                const data = await res.json();
                if (data.error) {
                    alert(data.error);
                    return;
                }

                board = data.board || board;
                gameOver = data.winner !== null;
                renderBoard();
                updateStatus(data.winner);
                updateCellInteractivity();
            } catch (e) {
                console.error("Move failed:", e);
                alert("Move failed. See console.");
            } finally {
                isFetching = false;
                showLoading(false);
            }
        }

        function renderBoard() {
            document.querySelectorAll(".cell").forEach((cell, i) => {
                cell.classList.remove("x", "o");
                if (board[i] === 1) {
                    cell.innerText = "X";
                    cell.classList.add("x");
                } else if (board[i] === -1) {
                    cell.innerText = "O";
                    cell.classList.add("o");
                } else {
                    cell.innerText = "";
                }
            });
        }

        function updateStatus(winner) {
            const statusEl = document.getElementById("status");
            if (winner !== null) {
                if (winner === 1) statusEl.innerText = "Agent Wins!";
                else if (winner === 2) statusEl.innerText = "You Win!";
                else statusEl.innerText = "It's a Draw!";
            } else {
                statusEl.innerText = "Your Turn!";
            }
        }

        function showLoading(show) {
            document.getElementById("loading").style.display = show ? "block" : "none";
        }

        function updateCellInteractivity() {
            document.querySelectorAll(".cell").forEach(cell => {
                const id = parseInt(cell.getAttribute("data-id"));
                if (gameOver || isFetching || board[id] !== 0) {
                    cell.classList.add("disabled");
                } else {
                    cell.classList.remove("disabled");
                }
            });
        }

        async function resetGame() {
            board = Array(9).fill(0);
            gameOver = false;
            renderBoard();
            updateCellInteractivity();
            document.getElementById("status").innerText = "Your Turn!";
            showLoading(false);

            try {
                await fetch("/api/tictactoe/reset", { method: "POST" });
            } catch (e) {
                console.error("Reset error:", e);
            }
        }
    </script>
</body>

</html>